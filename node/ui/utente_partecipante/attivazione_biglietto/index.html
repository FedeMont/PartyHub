<!DOCTYPE html>
<html>

<head>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <link rel="stylesheet" href="../public/css/style.css">

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
</head>

<body>
    <div class="container">
        <div id="event_info" class="col s12" style="width:100%">
            <!-- EVENT INFO -->
            <div class="row"></div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="/public/script/utils.js"></script>

    <script>

        let event_item = (obj) => {
            let to_return = `
            <div class="row valign-wrapper">
                <div class="col s7 left-align">
                    <h5>${obj.name}</h5>
                    <h6 class="grey-text">${new Date(obj.start_datetime).toLocaleDateString().slice(0, 10).replace(/-/g, "/")}</h6>
                </div>
                <div id="total_price" class="col s5 right-align">
                </div>
            </div>`;

            if (obj.biglietto_active) {
                return to_return;
            }

            return to_return + `
            <div class="row center-align">
                <div class="col s12 center-align">
                    <div class="row">
                        <h6 class="grey-text">${obj.name}</h6>
                    </div>

                    <div class="row">
                        <i class="xl material-icons grey-text ">confirmation_number</i>
                    </div>
                    <div class="row">
                        <a id="entra_button">Entra e genera QR code</a>
                    </div>
                </div>
            </div>
            `;
        };

        let event_active_item = (biglietto) => {
            return `<div class="row center-align">
                <div class="col s12 center-align">
                    <div class="row">
                        <i class="xl material-icons blue-text ">confirmation_number</i>
                        <h6 class="grey-text" style="margin-top: -1rem;">Entrata: ${new Date(biglietto.entrance_datetime).toTimeString().slice(0, 5)}</h6> 
                    </div>
                </div>
            </div>
            <div class="row">
                <ul id="products_list" class="collection">
                    <!-- PRODUCT -->
                </ul>
            </div>
            `;
        };

        let generate_products_list_item = (obj) => {
            console.log(obj);
            return `
            <li class="collection-item avatar valign-wrapper" style="min-height: 0;">
                <i class="material-icons circle">local_drink</i>
                <h6>${obj.name}</h6>
                <p class="secondary-content grey-text valign-wrapper">${parseFloat(obj.price).toFixed(2)} €</p>
            </li>
            `;
        };

        $.ajax({
            url: "/api/event/get_event_by_biglietto_id",
            type: "GET",
            data: {
                biglietto_id: "62864afbb7560cee6f4dc9da"
            },
            success: (data) => {
                console.log(data.message);
                event = data.message;
                $("#event_info").append(event_item(event));

                if (event.biglietto_active === true) {
                    $.ajax({
                        url: "/api/biglietto/get_products",
                        type: "GET",
                        data: {
                            biglietto_id: "62864afbb7560cee6f4dc9da",
                        },
                        success: (data) => {
                            console.log(data.message);
                            $("#event_info").append(event_active_item(data.message));
                            $("#total_price").append("<p class='secondary-content black-text'>Totale: " + parseFloat(data.message.total_price).toFixed(2) + "€</p>");
                            data.message.products_list.forEach((product) => {
                                $("#products_list").append(generate_products_list_item(product));
                            });

                        }, error: (data) => {
                            console.log(data);
                            M.toast({ html: data.responseJSON.message });
                        }
                    });
                } else {
                    $("#entra_button").click(() => {
                        $.ajax({
                            url: "/api/biglietto/activate",
                            type: "POST",
                            data: {
                                biglietto_id: "62864afbb7560cee6f4dc9da",
                                event_id: "6284e081784e45559fed7f99"
                            },
                            success: (data) => {
                                console.log(data.message);

                            }, error: (data) => {
                                console.log(data);
                                M.toast({ html: data.responseJSON.message });
                            }
                        });
                    });
                }

            }, error: (data) => {
                console.log(data);
                M.toast({ html: data.responseJSON.message });
            }
        });

    </script>
</body>

</html>